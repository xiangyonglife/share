{% extends 'layout.html' %}
{% block template %}
    <div class="content-wrap">
        <div class="content">
            <header class="article-header">
                <h1 class="article-title"><a href="http://cmsblogs.com/?p=2620">【死磕Sharding-jdbc】—orchestration实现</a>
                </h1>
                <div class="article-meta">
                    <span class="item">2018-08-09</span>
                    <span class="item">分类：<a href="http://cmsblogs.com/?cat=184"
                                             rel="category">死磕Sharding-jdbc</a></span>
                    <span class="item post-views">阅读(116)</span> <span class="item">评论(0)</span>
                    <span class="item"></span>
                </div>
            </header>
            <article class="article-content">
                <blockquote><p>
                    原文作者：<a href="https://www.jianshu.com/u/6779ec81d3b7">阿飞Javaer</a><br>
                    原文链接：<a href="https://www.jianshu.com/p/60440c317d95">https://www.jianshu.com/p/60440c317d95</a>
                </p></blockquote>
                <hr>
                <p><img src="http://cmsblogs.qiniudn.com/201808091002.png" alt="201808091002" data-tag="bdshare"></p>
                <p>orchestration源码结构图.png</p>
                <p>根据源码图解可知，<strong>sharding-jdbc-orchestration</strong>模块中创建数据源有两种方式：工厂类和spring；且有两种数据源类型：<strong>OrchestrationShardingDataSource</strong>和<strong>OrchestrationMasterSlaveDataSource</strong>；
                </p>
                <ul>
                    <li>左边是<strong>OrchestrationShardingDataSource</strong>类型数据源创建，配置信息持久化以及监听&amp;刷新过程；右边是<strong>OrchestrationMasterSlaveDataSource</strong>类型数据源创建，配置信息持久化以及监听&amp;刷新过程；
                    </li>
                    <li>工厂类方式通过<strong>OrchestrationShardingDataSourceFactory</strong>或者<strong>OrchestrationMasterSlaveDataSourceFactory</strong>创建；
                    </li>
                    <li>spring方式通过解析xml配置文件创建（可以参考<strong>OrchestrationShardingNamespaceTest</strong>测试用例）；</li>
                    <li>得到数据源后，调用OrchestrationFacade.init()方法；在该init()方法中持久化配置信息到注册中心中；并创建监听器；</li>
                </ul>
                <blockquote><p>
                    由图可知，两种类型数据源的处理大同小异，本篇文章只分析<strong>OrchestrationShardingDataSource</strong>这种类型的数据源；
                </p></blockquote>
                <h1>源码分析</h1>
                <p>接下来通过工厂类创建<strong>OrchestrationShardingDataSource</strong>类型数据源源码剖析orchestration的实现原理；</p>
                <h2>1.创建数据源</h2>
                <p>通过测试用例<strong>YamlOrchestrationShardingIntegrateTest</strong>可知，创建数据源的代码为<strong>OrchestrationShardingDataSourceFactory.createDataSource(yamlFile);</strong>这段代码的实现如下所示：
                </p>
                <pre class="line-numbers prism-highlight prettyprint"><code class="language-null"><span class="lit">@NoArgsConstructor</span><span
                        class="pun">(</span><span class="pln">access </span><span class="pun">=</span><span
                        class="pln"> </span><span class="typ">AccessLevel</span><span class="pun">.</span><span
                        class="pln">PRIVATE</span><span class="pun">)</span><span class="pln">
</span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">final</span><span class="pln"> </span><span
                        class="kwd">class</span><span class="pln"> </span><span class="typ">OrchestrationShardingDataSourceFactory</span><span
                        class="pln"> </span><span class="pun">{</span><span class="pln">

    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span
                        class="pln"> </span><span class="typ">DataSource</span><span
                        class="pln"> createDataSource</span><span class="pun">(</span><span class="pln">
            </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">Map</span><span
                        class="pun">&lt;</span><span class="typ">String</span><span class="pun">,</span><span
                        class="pln"> </span><span class="typ">DataSource</span><span class="pun">&gt;</span><span
                        class="pln"> dataSourceMap</span><span class="pun">,</span><span class="pln"> </span><span
                        class="kwd">final</span><span class="pln"> </span><span
                        class="typ">ShardingRuleConfiguration</span><span class="pln"> shardingRuleConfig</span><span
                        class="pun">,</span><span class="pln">
            </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">Map</span><span
                        class="pun">&lt;</span><span class="typ">String</span><span class="pun">,</span><span
                        class="pln"> </span><span class="typ">Object</span><span class="pun">&gt;</span><span
                        class="pln"> configMap</span><span class="pun">,</span><span class="pln"> </span><span
                        class="kwd">final</span><span class="pln"> </span><span class="typ">Properties</span><span
                        class="pln"> props</span><span class="pun">,</span><span class="pln">
            </span><span class="kwd">final</span><span class="pln"> </span><span
                        class="typ">OrchestrationConfiguration</span><span class="pln"> orchestrationConfig</span><span
                        class="pun">)</span><span class="pln"> </span><span class="kwd">throws</span><span
                        class="pln"> </span><span class="typ">SQLException</span><span class="pln"> </span><span
                        class="pun">{</span><span class="pln">
        </span><span class="com">// step3.1 创建OrchestrationShardingDataSource数据源</span><span class="pln">
        </span><span class="typ">OrchestrationShardingDataSource</span><span class="pln"> result </span><span
                        class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span
                        class="pln"> </span><span class="typ">OrchestrationShardingDataSource</span><span
                        class="pun">(</span><span class="pln">dataSourceMap</span><span class="pun">,</span><span
                        class="pln"> shardingRuleConfig</span><span class="pun">,</span><span
                        class="pln"> configMap</span><span class="pun">,</span><span class="pln"> props</span><span
                        class="pun">,</span><span class="pln"> orchestrationConfig</span><span
                        class="pun">);</span><span class="pln">
        </span><span class="com">// step3.2 初始化（这里是sharding-jdb orchestration编排治理的核心）</span><span class="pln">
        result</span><span class="pun">.</span><span class="pln">init</span><span class="pun">();</span><span
                        class="pln">
        </span><span class="kwd">return</span><span class="pln"> result</span><span class="pun">;</span><span
                        class="pln">
    </span><span class="pun">}</span><span class="pln">

    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span
                        class="pln"> </span><span class="typ">DataSource</span><span
                        class="pln"> createDataSource</span><span class="pun">(</span><span
                        class="kwd">final</span><span class="pln"> </span><span class="typ">File</span><span
                        class="pln"> yamlFile</span><span class="pun">)</span><span class="pln"> </span><span
                        class="kwd">throws</span><span class="pln"> </span><span class="typ">SQLException</span><span
                        class="pun">,</span><span class="pln"> </span><span class="typ">IOException</span><span
                        class="pln"> </span><span class="pun">{</span><span class="pln">
        </span><span class="com">// step1\. 解析yaml文件得到YamlOrchestrationShardingRuleConfiguration</span><span
                        class="pln">
        </span><span class="typ">YamlOrchestrationShardingRuleConfiguration</span><span class="pln"> config </span><span
                        class="pun">=</span><span class="pln"> unmarshal</span><span class="pun">(</span><span
                        class="pln">yamlFile</span><span class="pun">);</span><span class="pln">
        </span><span class="com">// step2\. 得到分库分表规则配置，即根据yaml文件中shardingRule节点信息得到的分库分表规则配置</span><span class="pln">
        </span><span class="typ">YamlShardingRuleConfiguration</span><span class="pln"> shardingRuleConfig </span><span
                        class="pun">=</span><span class="pln"> config</span><span class="pun">.</span><span class="pln">getShardingRule</span><span
                        class="pun">();</span><span class="pln">
        </span><span class="com">// step3\. 调用上面的方法创建数据源</span><span class="pln">
        </span><span class="kwd">return</span><span class="pln"> createDataSource</span><span class="pun">(</span><span
                        class="pln">config</span><span class="pun">.</span><span class="pln">getDataSources</span><span
                        class="pun">(),</span><span class="pln"> shardingRuleConfig</span><span
                        class="pun">.</span><span class="pln">getShardingRuleConfiguration</span><span
                        class="pun">(),</span><span class="pln">
                shardingRuleConfig</span><span class="pun">.</span><span class="pln">getConfigMap</span><span
                        class="pun">(),</span><span class="pln"> shardingRuleConfig</span><span
                        class="pun">.</span><span class="pln">getProps</span><span class="pun">(),</span><span
                        class="pln"> config</span><span class="pun">.</span><span
                        class="pln">getOrchestration</span><span class="pun">().</span><span class="pln">getOrchestrationConfiguration</span><span
                        class="pun">());</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">

    </span><span class="com">// 一些其他创建数据源的方式，大同小异，暂时省略</span><span class="pln">
    </span><span class="pun">...</span><span class="pln"> </span><span class="pun">...</span><span class="pln">
</span><span class="pun">}</span></code></pre>
                <blockquote><p>
                    OrchestrationShardingDataSource.init()方法会调用OrchestrationFacade.init()方法，所以分析后者即可；
                </p></blockquote>
                <h2>2.持久化</h2>
                <p>OrchestrationFacade.init()核心源码如下：</p>
                <pre class="line-numbers prism-highlight prettyprint"><code class="language-null"><span class="kwd">public</span><span
                        class="pln"> </span><span class="kwd">void</span><span class="pln"> init</span><span
                        class="pun">(</span><span class="pln">
        </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">Map</span><span class="pun">&lt;</span><span
                        class="typ">String</span><span class="pun">,</span><span class="pln"> </span><span class="typ">DataSource</span><span
                        class="pun">&gt;</span><span class="pln"> dataSourceMap</span><span class="pun">,</span><span
                        class="pln">
        </span><span class="kwd">final</span><span class="pln"> </span><span
                        class="typ">ShardingRuleConfiguration</span><span class="pln"> shardingRuleConfig</span><span
                        class="pun">,</span><span class="pln">
        </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">Map</span><span class="pun">&lt;</span><span
                        class="typ">String</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Object</span><span
                        class="pun">&gt;</span><span class="pln"> configMap</span><span class="pun">,</span><span
                        class="pln">
        </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">Properties</span><span
                        class="pln"> props</span><span class="pun">,</span><span class="pln">
        </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">ShardingDataSource</span><span
                        class="pln"> shardingDataSource</span><span class="pun">)</span><span class="pln"> </span><span
                        class="kwd">throws</span><span class="pln"> </span><span class="typ">SQLException</span><span
                        class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="com">// step1\. 持久化sharding规则配置，且为PERSISTENT类型节点</span><span class="pln">
    configService</span><span class="pun">.</span><span class="pln">persistShardingConfiguration</span><span
                        class="pun">(</span><span class="pln">getActualDataSourceMapForMasterSlave</span><span
                        class="pun">(</span><span class="pln">dataSourceMap</span><span class="pun">),</span><span
                        class="pln"> shardingRuleConfig</span><span class="pun">,</span><span
                        class="pln"> configMap</span><span class="pun">,</span><span class="pln"> props</span><span
                        class="pun">,</span><span class="pln"> isOverwrite</span><span class="pun">);</span><span
                        class="pln">
    </span><span class="com">// step2\. 持久化sharding实例信息，且为EPHEMERAL类型节点</span><span class="pln">
    instanceStateService</span><span class="pun">.</span><span class="pln">persistShardingInstanceOnline</span><span
                        class="pun">();</span><span class="pln">
    </span><span class="com">// step3\. 持久化数据源节点信息，且为PERSISTENT类型节点</span><span class="pln">
    dataSourceService</span><span class="pun">.</span><span class="pln">persistDataSourcesNode</span><span class="pun">();</span><span
                        class="pln">
    </span><span class="com">// step4\. 注册监听器</span><span class="pln">
    listenerManager</span><span class="pun">.</span><span class="pln">initShardingListeners</span><span
                        class="pun">(</span><span class="pln">shardingDataSource</span><span class="pun">);</span><span
                        class="pln">
</span><span class="pun">}</span></code></pre>
                <blockquote><p>
                    所以说，这里就是sharding-jdbc编排治理的核心--配置信息持久化，注册监听器；接下来先分析编排治理的配置信息持久化；
                </p></blockquote>
                <h3>2.1持久化sharding规则配置</h3>
                <p>持久化sharding规则配置的核心实现如下，我们接下来一一分析其持久化的内容；</p>
                <pre class="line-numbers prism-highlight prettyprint"><code class="language-null"><span class="kwd">public</span><span
                        class="pln"> </span><span class="kwd">void</span><span
                        class="pln"> persistShardingConfiguration</span><span class="pun">(</span><span class="pln">
        </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">Map</span><span class="pun">&lt;</span><span
                        class="typ">String</span><span class="pun">,</span><span class="pln"> </span><span class="typ">DataSource</span><span
                        class="pun">&gt;</span><span class="pln"> dataSourceMap</span><span class="pun">,</span><span
                        class="pln">
        </span><span class="kwd">final</span><span class="pln"> </span><span
                        class="typ">ShardingRuleConfiguration</span><span class="pln"> shardingRuleConfig</span><span
                        class="pun">,</span><span class="pln">
        </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">Map</span><span class="pun">&lt;</span><span
                        class="typ">String</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Object</span><span
                        class="pun">&gt;</span><span class="pln"> configMap</span><span class="pun">,</span><span
                        class="pln">
        </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">Properties</span><span
                        class="pln"> props</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">final</span><span
                        class="pln"> </span><span class="kwd">boolean</span><span class="pln"> isOverwrite</span><span
                        class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    persistDataSourceConfiguration</span><span class="pun">(</span><span class="pln">dataSourceMap</span><span
                        class="pun">,</span><span class="pln"> isOverwrite</span><span class="pun">);</span><span
                        class="pln">
    persistShardingRuleConfiguration</span><span class="pun">(</span><span class="pln">shardingRuleConfig</span><span
                        class="pun">,</span><span class="pln"> isOverwrite</span><span class="pun">);</span><span
                        class="pln">
    persistShardingConfigMap</span><span class="pun">(</span><span class="pln">configMap</span><span
                        class="pun">,</span><span class="pln"> isOverwrite</span><span class="pun">);</span><span
                        class="pln">
    persistShardingProperties</span><span class="pun">(</span><span class="pln">props</span><span
                        class="pun">,</span><span class="pln"> isOverwrite</span><span class="pun">);</span><span
                        class="pln">
</span><span class="pun">}</span></code></pre>
                <ul>
                    <li>持久化数据源配置<br>
                        对应源码为<strong>persistDataSourceConfiguration(dataSourceMap, isOverwrite);</strong>核心实现源码如下：
                    </li>
                </ul>
                <pre class="line-numbers prism-highlight prettyprint"><code class="language-null"><span class="kwd">private</span><span
                        class="pln"> </span><span class="kwd">void</span><span class="pln"> persistDataSourceConfiguration</span><span
                        class="pun">(</span><span class="kwd">final</span><span class="pln"> </span><span class="typ">Map</span><span
                        class="pun">&lt;</span><span class="typ">String</span><span class="pun">,</span><span
                        class="pln"> </span><span class="typ">DataSource</span><span class="pun">&gt;</span><span
                        class="pln"> dataSourceMap</span><span class="pun">,</span><span class="pln"> </span><span
                        class="kwd">final</span><span class="pln"> </span><span class="kwd">boolean</span><span
                        class="pln"> isOverwrite</span><span class="pun">)</span><span class="pln"> </span><span
                        class="pun">{</span><span class="pln">
    </span><span class="com">// 如果配置了overwrite，或者/demo_ds_ms/config/datasource节点还不存在，那么就持久化数据源相关配置；</span><span
                        class="pln">
    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span
                        class="pln">isOverwrite </span><span class="pun">||</span><span class="pln"> </span><span
                        class="pun">!</span><span class="pln">hasDataSourceConfiguration</span><span
                        class="pun">())</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
        regCenter</span><span class="pun">.</span><span class="pln">persist</span><span class="pun">(</span><span
                        class="pln">configNode</span><span class="pun">.</span><span class="pln">getFullPath</span><span
                        class="pun">(</span><span class="typ">ConfigurationNode</span><span class="pun">.</span><span
                        class="pln">DATA_SOURCE_NODE_PATH</span><span class="pun">),</span><span
                        class="pln"> </span><span class="typ">DataSourceJsonConverter</span><span
                        class="pun">.</span><span class="pln">toJson</span><span class="pun">(</span><span class="pln">dataSourceMap</span><span
                        class="pun">));</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">
</span><span class="pun">}</span></code></pre>
                <p>根据上面的分析得出数据源配置路径为：<code>/orchestration-yaml-test/demo_ds_ms/config/datasource</code>。即完整路径表达式为：<code>/${orchestration.zookeeper.namespace}/${orchestration.name}/config/datasource</code>；其他几个配置信息持久化的源码分析类似；
                </p>
                <h3>2.2节点配置信息与源码对应关系</h3>
                <pre class="line-numbers prism-highlight prettyprint"><code class="language-null"><span class="pln">config
    </span><span class="pun">├──</span><span class="pln">datasource                                persistDataSourceConfiguration</span><span
                        class="pun">()</span><span class="pln">
    </span><span class="pun">├──</span><span class="pln">sharding
    </span><span class="pun">├</span><span class="pln">      </span><span class="pun">├──</span><span class="pln">rule                               persistShardingRuleConfiguration</span><span
                        class="pun">()</span><span class="pln">
    </span><span class="pun">├</span><span class="pln">      </span><span class="pun">├──</span><span class="pln">configmap                          persistShardingConfigMap</span><span
                        class="pun">()</span><span class="pln">
    </span><span class="pun">├</span><span class="pln">      </span><span class="pun">├──</span><span class="pln">props                              persistShardingProperties</span><span
                        class="pun">()</span><span class="pln">
    </span><span class="pun">├──</span><span class="pln">masterslave
    </span><span class="pun">├</span><span class="pln">      </span><span class="pun">├──</span><span class="pln">rule
    </span><span class="pun">├</span><span class="pln">      </span><span class="pun">├──</span><span class="pln">configmap
state
    </span><span class="pun">├──</span><span class="pln">instances                                persistShardingInstanceOnline</span><span
                        class="pun">()</span><span class="pln">
    </span><span class="pun">├</span><span class="pln">      </span><span class="pun">├──</span><span
                        class="pln">$</span><span class="pun">{</span><span class="pln">instance1</span><span
                        class="pun">-</span><span class="pln">ip</span><span class="pun">}</span><span
                        class="lit">@$</span><span class="pun">{</span><span class="pln">pid</span><span
                        class="pun">}</span><span class="lit">@$</span><span class="pun">{</span><span
                        class="pln">uuid</span><span class="pun">}</span><span class="pln">
    </span><span class="pun">├</span><span class="pln">      </span><span class="pun">├──</span><span
                        class="pln">$</span><span class="pun">{</span><span class="pln">instance2</span><span
                        class="pun">-</span><span class="pln">ip</span><span class="pun">}</span><span
                        class="lit">@$</span><span class="pun">{</span><span class="pln">pid</span><span
                        class="pun">}</span><span class="lit">@$</span><span class="pun">{</span><span
                        class="pln">uuid</span><span class="pun">}</span><span class="pln">
    </span><span class="pun">├──</span><span
                        class="pln">datasources                              persistDataSourcesNode</span><span
                        class="pun">()</span></code></pre>
                <blockquote><p>
                    说明：节点信息省略了路径前缀<code>/${orchestration.zookeeper.namespace}/${orchestration.name}</code>；例如，某instance节点的完整路径：：<code>/${orchestration.zookeeper.namespace}/${orchestration.name}/state/instances/${ip}@${pid}@${uuid}</code>（/demo_ds_ms/state/instances/10.0.0.189@10072@6f8f1b1e-90a4-4edd-baf9-aeb906a664bd）；
                </p></blockquote>
                <h2>3.创建监听器</h2>
                <p><strong>OrchestrationFacade.init()</strong>中调用persist*<strong>()方法持久化各配置信息到注册中心后，再调用</strong>listenerManager.initShardingListeners(shardingDataSource)**创建监听器，核心源码如下：
                </p>
                <pre class="line-numbers prism-highlight prettyprint"><code class="language-null"><span class="kwd">public</span><span
                        class="pln"> </span><span class="kwd">void</span><span class="pln"> initShardingListeners</span><span
                        class="pun">(</span><span class="kwd">final</span><span class="pln"> </span><span class="typ">ShardingDataSource</span><span
                        class="pln"> shardingDataSource</span><span class="pun">)</span><span class="pln"> </span><span
                        class="pun">{</span><span class="pln">
    </span><span class="com">// 监听三个节点(/config/datasource, /config/sharding/rule, /config/sharding/props)</span><span
                        class="pln">
    configurationListenerManager</span><span class="pun">.</span><span class="pln">start</span><span
                        class="pun">(</span><span class="pln">shardingDataSource</span><span class="pun">);</span><span
                        class="pln">
    </span><span class="com">// 监听节点/state/instances/${instance-ip}@${pid}@${uuid}，即监听表示当前实例的节点</span><span class="pln">
    instanceListenerManager</span><span class="pun">.</span><span class="pln">start</span><span
                        class="pun">(</span><span class="pln">shardingDataSource</span><span class="pun">);</span><span
                        class="pln">
    </span><span class="com">// 监听节点/state/datasources</span><span class="pln">
    dataSourceListenerManager</span><span class="pun">.</span><span class="pln">start</span><span
                        class="pun">(</span><span class="pln">shardingDataSource</span><span class="pun">);</span><span
                        class="pln">
    </span><span class="com">// 监听节点/config/sharding/cofigmap</span><span class="pln">
    configMapListenerManager</span><span class="pun">.</span><span class="pln">start</span><span
                        class="pun">(</span><span class="pln">shardingDataSource</span><span class="pun">);</span><span
                        class="pln">
</span><span class="pun">}</span></code></pre>
                <h3>3.1 rule节点监听分析</h3>
                <p>核心源码如下：</p>
                <pre class="line-numbers prism-highlight prettyprint"><code class="language-null"><span class="kwd">private</span><span
                        class="pln"> </span><span class="kwd">void</span><span class="pln"> start</span><span
                        class="pun">(</span><span class="kwd">final</span><span class="pln"> </span><span class="typ">String</span><span
                        class="pln"> node</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">final</span><span
                        class="pln"> </span><span class="typ">ShardingDataSource</span><span class="pln"> shardingDataSource</span><span
                        class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="com">// 得到监听的路径/config/sharding/rule</span><span class="pln">
    </span><span class="typ">String</span><span class="pln"> cachePath </span><span class="pun">=</span><span
                        class="pln"> configNode</span><span class="pun">.</span><span
                        class="pln">getFullPath</span><span class="pun">(</span><span class="pln">node</span><span
                        class="pun">);</span><span class="pln">
    </span><span class="com">// watch该注册中心中该路径</span><span class="pln">
    regCenter</span><span class="pun">.</span><span class="pln">watch</span><span class="pun">(</span><span class="pln">cachePath</span><span
                        class="pun">,</span><span class="pln"> </span><span class="kwd">new</span><span
                        class="pln"> </span><span class="typ">EventListener</span><span class="pun">()</span><span
                        class="pln"> </span><span class="pun">{</span><span class="pln">

        </span><span class="lit">@Override</span><span class="pln">
        </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> onChange</span><span
                        class="pun">(</span><span class="kwd">final</span><span class="pln"> </span><span class="typ">DataChangedEvent</span><span
                        class="pln"> </span><span class="kwd">event</span><span class="pun">)</span><span
                        class="pln"> </span><span class="pun">{</span><span class="pln">
            </span><span class="com">// 只处理UPDATED类型事件</span><span class="pln">
            </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="typ">DataChangedEvent</span><span
                        class="pun">.</span><span class="typ">Type</span><span class="pun">.</span><span class="pln">UPDATED </span><span
                        class="pun">==</span><span class="pln"> </span><span class="kwd">event</span><span
                        class="pun">.</span><span class="pln">getEventType</span><span class="pun">())</span><span
                        class="pln"> </span><span class="pun">{</span><span class="pln">
                </span><span class="kwd">try</span><span class="pln"> </span><span class="pun">{</span><span
                        class="pln">
                    </span><span class="com">// 调用loadShardingProperties()从配置中心中拿出/config/datasource和/config/sharding/props两个路径的数据准备刷新sharding数据源</span><span
                        class="pln">
                    shardingDataSource</span><span class="pun">.</span><span class="pln">renew</span><span
                        class="pun">(</span><span class="pln">dataSourceService</span><span class="pun">.</span><span
                        class="pln">getAvailableShardingRuleConfiguration</span><span class="pun">().</span><span
                        class="pln">build</span><span class="pun">(</span><span
                        class="pln">dataSourceService</span><span class="pun">.</span><span class="pln">getAvailableDataSources</span><span
                        class="pun">()),</span><span class="pln"> configService</span><span class="pun">.</span><span
                        class="pln">loadShardingProperties</span><span class="pun">());</span><span class="pln">
                </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">catch</span><span
                        class="pln"> </span><span class="pun">(</span><span class="kwd">final</span><span
                        class="pln"> </span><span class="typ">SQLException</span><span class="pln"> ex</span><span
                        class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
                    </span><span class="kwd">throw</span><span class="pln"> </span><span class="kwd">new</span><span
                        class="pln"> </span><span class="typ">ShardingJdbcException</span><span
                        class="pun">(</span><span class="pln">ex</span><span class="pun">);</span><span class="pln">
                </span><span class="pun">}</span><span class="pln">
            </span><span class="pun">}</span><span class="pln">
        </span><span class="pun">}</span><span class="pln">
    </span><span class="pun">});</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span
                        class="typ">ShardingDataSource</span><span class="pln"> </span><span
                        class="kwd">extends</span><span class="pln"> </span><span
                        class="typ">AbstractDataSourceAdapter</span><span class="pln"> </span><span class="kwd">implements</span><span
                        class="pln"> </span><span class="typ">AutoCloseable</span><span class="pln"> </span><span
                        class="pun">{</span><span class="pln">
    </span><span class="pun">...</span><span class="pln"> </span><span class="pun">...</span><span class="pln">
    </span><span class="com">// 刷新ShardingContext</span><span class="pln">
    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> renew</span><span
                        class="pun">(</span><span class="kwd">final</span><span class="pln"> </span><span class="typ">ShardingRule</span><span
                        class="pln"> newShardingRule</span><span class="pun">,</span><span class="pln"> </span><span
                        class="kwd">final</span><span class="pln"> </span><span class="typ">Properties</span><span
                        class="pln"> newProps</span><span class="pun">)</span><span class="pln"> </span><span
                        class="kwd">throws</span><span class="pln"> </span><span class="typ">SQLException</span><span
                        class="pln"> </span><span class="pun">{</span><span class="pln">
        </span><span class="typ">ShardingProperties</span><span class="pln"> newShardingProperties </span><span
                        class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span
                        class="pln"> </span><span class="typ">ShardingProperties</span><span class="pun">(</span><span
                        class="kwd">null</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> newProps </span><span
                        class="pun">?</span><span class="pln"> </span><span class="kwd">new</span><span
                        class="pln"> </span><span class="typ">Properties</span><span class="pun">()</span><span
                        class="pln"> </span><span class="pun">:</span><span class="pln"> newProps</span><span
                        class="pun">);</span><span class="pln">
        </span><span class="com">// 得到更新前的executor.size的值</span><span class="pln">
        </span><span class="kwd">int</span><span class="pln"> originalExecutorSize </span><span
                        class="pun">=</span><span class="pln"> shardingProperties</span><span class="pun">.</span><span
                        class="pln">getValue</span><span class="pun">(</span><span class="typ">ShardingPropertiesConstant</span><span
                        class="pun">.</span><span class="pln">EXECUTOR_SIZE</span><span class="pun">);</span><span
                        class="pln">
        </span><span class="com">// 得到更新后的executor.size的值</span><span class="pln">
        </span><span class="kwd">int</span><span class="pln"> newExecutorSize </span><span class="pun">=</span><span
                        class="pln"> newShardingProperties</span><span class="pun">.</span><span
                        class="pln">getValue</span><span class="pun">(</span><span class="typ">ShardingPropertiesConstant</span><span
                        class="pun">.</span><span class="pln">EXECUTOR_SIZE</span><span class="pun">);</span><span
                        class="pln">
        </span><span class="com">// 如果executor.size的值有变化则重新构造ExecutorEngine</span><span class="pln">
        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">originalExecutorSize </span><span
                        class="pun">!=</span><span class="pln"> newExecutorSize</span><span class="pun">)</span><span
                        class="pln"> </span><span class="pun">{</span><span class="pln">
            executorEngine</span><span class="pun">.</span><span class="pln">close</span><span
                        class="pun">();</span><span class="pln">
            executorEngine </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span
                        class="pln"> </span><span class="typ">ExecutorEngine</span><span class="pun">(</span><span
                        class="pln">newExecutorSize</span><span class="pun">);</span><span class="pln">
        </span><span class="pun">}</span><span class="pln">
        </span><span class="com">// 得到更新后的sql.show的值</span><span class="pln">
        </span><span class="kwd">boolean</span><span class="pln"> newShowSQL </span><span class="pun">=</span><span
                        class="pln"> newShardingProperties</span><span class="pun">.</span><span
                        class="pln">getValue</span><span class="pun">(</span><span class="typ">ShardingPropertiesConstant</span><span
                        class="pun">.</span><span class="pln">SQL_SHOW</span><span class="pun">);</span><span
                        class="pln">
        shardingProperties </span><span class="pun">=</span><span class="pln"> newShardingProperties</span><span
                        class="pun">;</span><span class="pln">
        </span><span class="com">// 重新构造ShardingContext</span><span class="pln">
        shardingContext </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span
                        class="pln"> </span><span class="typ">ShardingContext</span><span class="pun">(</span><span
                        class="pln">newShardingRule</span><span class="pun">,</span><span
                        class="pln"> getDatabaseType</span><span class="pun">(),</span><span
                        class="pln"> executorEngine</span><span class="pun">,</span><span class="pln"> newShowSQL</span><span
                        class="pun">);</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">
    </span><span class="pun">...</span><span class="pln"> </span><span class="pun">...</span><span class="pln">
</span><span class="pun">}</span></code></pre>
                <p>ShardingContext 包含如下属性--rule节点有变更时，这些属性都会得到更新；</p>
                <pre class="line-numbers prism-highlight prettyprint"><code class="language-null"><span class="kwd">public</span><span
                        class="pln"> </span><span class="kwd">final</span><span class="pln"> </span><span class="kwd">class</span><span
                        class="pln"> </span><span class="typ">ShardingContext</span><span class="pln"> </span><span
                        class="pun">{</span><span class="pln">
    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">final</span><span
                        class="pln"> </span><span class="typ">ShardingRule</span><span
                        class="pln"> shardingRule</span><span class="pun">;</span><span class="pln">
    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">final</span><span
                        class="pln"> </span><span class="typ">DatabaseType</span><span
                        class="pln"> databaseType</span><span class="pun">;</span><span class="pln">
    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">final</span><span
                        class="pln"> </span><span class="typ">ExecutorEngine</span><span
                        class="pln"> executorEngine</span><span class="pun">;</span><span class="pln">
    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">final</span><span
                        class="pln"> </span><span class="kwd">boolean</span><span class="pln"> showSQL</span><span
                        class="pun">;</span><span class="pln">
</span><span class="pun">}</span></code></pre>
                <h3>3.2 props节点监听分析</h3>
                <p>props节点监听源码如下：</p>
                <pre class="line-numbers prism-highlight prettyprint"><code class="language-null"><span class="kwd">private</span><span
                        class="pln"> </span><span class="kwd">void</span><span class="pln"> start</span><span
                        class="pun">(</span><span class="kwd">final</span><span class="pln"> </span><span class="typ">String</span><span
                        class="pln"> node</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">final</span><span
                        class="pln"> </span><span class="typ">ShardingDataSource</span><span class="pln"> shardingDataSource</span><span
                        class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="com">// 监听的路径，即/${orchestration.zookeeper.namespace}/${orchestration.name}/config/sharding/props</span><span
                        class="pln">
    </span><span class="typ">String</span><span class="pln"> cachePath </span><span class="pun">=</span><span
                        class="pln"> configNode</span><span class="pun">.</span><span
                        class="pln">getFullPath</span><span class="pun">(</span><span class="pln">node</span><span
                        class="pun">);</span><span class="pln">
    </span><span class="com">// watch该路径</span><span class="pln">
    regCenter</span><span class="pun">.</span><span class="pln">watch</span><span class="pun">(</span><span class="pln">cachePath</span><span
                        class="pun">,</span><span class="pln"> </span><span class="kwd">new</span><span
                        class="pln"> </span><span class="typ">EventListener</span><span class="pun">()</span><span
                        class="pln"> </span><span class="pun">{</span><span class="pln">
        </span><span class="lit">@Override</span><span class="pln">
        </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> onChange</span><span
                        class="pun">(</span><span class="kwd">final</span><span class="pln"> </span><span class="typ">DataChangedEvent</span><span
                        class="pln"> </span><span class="kwd">event</span><span class="pun">)</span><span
                        class="pln"> </span><span class="pun">{</span><span class="pln">
            </span><span class="com">// 如果有UPDATED变更事件(只考虑UPDATED事件)</span><span class="pln">
            </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="typ">DataChangedEvent</span><span
                        class="pun">.</span><span class="typ">Type</span><span class="pun">.</span><span class="pln">UPDATED </span><span
                        class="pun">==</span><span class="pln"> </span><span class="kwd">event</span><span
                        class="pun">.</span><span class="pln">getEventType</span><span class="pun">())</span><span
                        class="pln"> </span><span class="pun">{</span><span class="pln">
                </span><span class="kwd">try</span><span class="pln"> </span><span class="pun">{</span><span
                        class="pln">
                    </span><span class="com">// 这里的逻辑和rule节点类型，刷新ShardingContext</span><span class="pln">
                    shardingDataSource</span><span class="pun">.</span><span class="pln">renew</span><span
                        class="pun">(</span><span class="pln">
                            dataSourceService</span><span class="pun">.</span><span class="pln">getAvailableShardingRuleConfiguration</span><span
                        class="pun">().</span><span class="pln">build</span><span class="pun">(</span><span class="pln">dataSourceService</span><span
                        class="pun">.</span><span class="pln">getAvailableDataSources</span><span
                        class="pun">()),</span><span class="pln">
                            configService</span><span class="pun">.</span><span
                        class="pln">loadShardingProperties</span><span class="pun">()</span><span class="pln">
                    </span><span class="pun">);</span><span class="pln">
                </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">catch</span><span
                        class="pln"> </span><span class="pun">(</span><span class="kwd">final</span><span
                        class="pln"> </span><span class="typ">SQLException</span><span class="pln"> ex</span><span
                        class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
                    </span><span class="kwd">throw</span><span class="pln"> </span><span class="kwd">new</span><span
                        class="pln"> </span><span class="typ">ShardingJdbcException</span><span
                        class="pun">(</span><span class="pln">ex</span><span class="pun">);</span><span class="pln">
                </span><span class="pun">}</span><span class="pln">
            </span><span class="pun">}</span><span class="pln">
        </span><span class="pun">}</span><span class="pln">
    </span><span class="pun">});</span><span class="pln">
</span><span class="pun">}</span></code></pre>
                <h3>3.3 instances节点监听分析</h3>
                <p>实际监听的是instances下代表某具体实例的节点，例如<strong>/orchestration-spring-namespace-test/shardingDataSource/state/instances/10.0.0.188@13272@42533e85-9bb1-4484-baa1-2a2f9b2480a6</strong>。核心源码如下：
                </p>
                <pre class="line-numbers prism-highlight prettyprint"><code class="language-null"><span class="lit">@Override</span><span
                        class="pln">
</span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span
                        class="pln"> start</span><span class="pun">(</span><span class="kwd">final</span><span
                        class="pln"> </span><span class="typ">ShardingDataSource</span><span class="pln"> shardingDataSource</span><span
                        class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    regCenter</span><span class="pun">.</span><span class="pln">watch</span><span class="pun">(</span><span class="pln">stateNode</span><span
                        class="pun">.</span><span class="pln">getInstancesNodeFullPath</span><span
                        class="pun">(</span><span class="typ">OrchestrationInstance</span><span
                        class="pun">.</span><span class="pln">getInstance</span><span class="pun">().</span><span
                        class="pln">getInstanceId</span><span class="pun">()),</span><span class="pln"> </span><span
                        class="kwd">new</span><span class="pln"> </span><span class="typ">EventListener</span><span
                        class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

        </span><span class="lit">@Override</span><span class="pln">
        </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> onChange</span><span
                        class="pun">(</span><span class="kwd">final</span><span class="pln"> </span><span class="typ">DataChangedEvent</span><span
                        class="pln"> </span><span class="kwd">event</span><span class="pun">)</span><span
                        class="pln"> </span><span class="pun">{</span><span class="pln">
            </span><span class="com">// 当收到UPDATED类型事件</span><span class="pln">
            </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="typ">DataChangedEvent</span><span
                        class="pun">.</span><span class="typ">Type</span><span class="pun">.</span><span class="pln">UPDATED </span><span
                        class="pun">==</span><span class="pln"> </span><span class="kwd">event</span><span
                        class="pun">.</span><span class="pln">getEventType</span><span class="pun">())</span><span
                        class="pln"> </span><span class="pun">{</span><span class="pln">
                </span><span class="com">// 首先拿到所有数据源</span><span class="pln">
                </span><span class="typ">Map</span><span class="pun">&lt;</span><span class="typ">String</span><span
                        class="pun">,</span><span class="pln"> </span><span class="typ">DataSource</span><span
                        class="pun">&gt;</span><span class="pln"> dataSourceMap </span><span class="pun">=</span><span
                        class="pln"> configService</span><span class="pun">.</span><span
                        class="pln">loadDataSourceMap</span><span class="pun">();</span><span class="pln">
                </span><span class="com">// 如果具体实例的节点的value被置为disabled（大小写不敏感），那么将该实例下所有数据源置为CircuitBreakerDataSource（这是sharding-jdbc自定义的一个特殊数据源，如果SQL路由到该数据源上，那么执行时不返回任何数据，也不实际执行该SQL，相当于一个mock的数据源）</span><span
                        class="pln">
                </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="typ">StateNodeStatus</span><span
                        class="pun">.</span><span class="pln">DISABLED</span><span class="pun">.</span><span
                        class="pln">toString</span><span class="pun">().</span><span class="pln">equalsIgnoreCase</span><span
                        class="pun">(</span><span class="pln">regCenter</span><span class="pun">.</span><span
                        class="kwd">get</span><span class="pun">(</span><span class="kwd">event</span><span class="pun">.</span><span
                        class="pln">getKey</span><span class="pun">())))</span><span class="pln"> </span><span
                        class="pun">{</span><span class="pln">
                    </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span
                        class="typ">String</span><span class="pln"> each </span><span class="pun">:</span><span
                        class="pln"> dataSourceMap</span><span class="pun">.</span><span class="pln">keySet</span><span
                        class="pun">())</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
                        dataSourceMap</span><span class="pun">.</span><span class="pln">put</span><span
                        class="pun">(</span><span class="pln">each</span><span class="pun">,</span><span
                        class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">CircuitBreakerDataSource</span><span
                        class="pun">());</span><span class="pln">
                    </span><span class="pun">}</span><span class="pln">
                </span><span class="pun">}</span><span class="pln">
                </span><span class="kwd">try</span><span class="pln"> </span><span class="pun">{</span><span
                        class="pln">
                    shardingDataSource</span><span class="pun">.</span><span class="pln">renew</span><span
                        class="pun">(</span><span class="pln">configService</span><span class="pun">.</span><span
                        class="pln">loadShardingRuleConfiguration</span><span class="pun">().</span><span class="pln">build</span><span
                        class="pun">(</span><span class="pln">dataSourceMap</span><span class="pun">),</span><span
                        class="pln"> configService</span><span class="pun">.</span><span class="pln">loadShardingProperties</span><span
                        class="pun">());</span><span class="pln">
                </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">catch</span><span
                        class="pln"> </span><span class="pun">(</span><span class="kwd">final</span><span
                        class="pln"> </span><span class="typ">SQLException</span><span class="pln"> ex</span><span
                        class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
                    </span><span class="kwd">throw</span><span class="pln"> </span><span class="kwd">new</span><span
                        class="pln"> </span><span class="typ">ShardingJdbcException</span><span
                        class="pun">(</span><span class="pln">ex</span><span class="pun">);</span><span class="pln">
                </span><span class="pun">}</span><span class="pln">
            </span><span class="pun">}</span><span class="pln">
        </span><span class="pun">}</span><span class="pln">
    </span><span class="pun">});</span><span class="pln">
</span><span class="pun">}</span></code></pre>
                <blockquote><p>
                    说明：将某个具体实例的节点的value置为<strong>disabled</strong>的命令(基于zookeeper)： <strong>set
                    /orchestration-spring-namespace-test/shardingDataSource/state/instances/10.52.16.134@13272@42533e85-9bb1-4484-baa1-2a2f9b2480a6
                    disabled</strong>，instances后面的<strong>10.52.16.134@13272@42533e85-9bb1-4484-baa1-2a2f9b2480a6</strong>视具体情况而定。
                </p></blockquote>
                <h3>3.4 其他节点监听分析</h3>
                <p>其他节点监听处理和上面两个的处理逻辑几乎大同小异，监听UPDATED事件，然后从注册中心加载最新的配置后刷新数据；</p>
            </article>

            <div class="asb-post-footer">
                <strong>【公告】</strong><a target="_blank" href="http://cmsblogs.com/?page_id=1908">版权声明</a>
                <center>
                    <img src="/wp-content/resources/img/qrcode_for_gh_3ec9de1135f5_344.jpg" width="300px" height="300px"
                         title="欢迎关注chenssy微信公众账号" alt="欢迎关注chenssy微信公众账号">
                </center>
                <center>欢迎关注chenssy微信公众账号</center>
            </div>

            <p class="post-copyright">如未加特殊说明，此网站文章均为原创，转载必须注明出处。<a href="http://cmsblogs.com">cmsblogs-chenssy</a> » <a
                    href="http://cmsblogs.com/?p=2620">【死磕Sharding-jdbc】—orchestration实现</a></p>
            <div class="action-share bdsharebuttonbox bdshare-button-style0-24" data-bd-bind="1534274098687">
                <span>分享到：</span><a class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a class="bds_tsina"
                                                                                              data-cmd="tsina"
                                                                                              title="分享到新浪微博"></a><a
                    class="bds_weixin" data-cmd="weixin" title="分享到微信"></a><a class="bds_tqq" data-cmd="tqq"
                                                                              title="分享到腾讯微博"></a><a class="bds_sqq"
                                                                                                     data-cmd="sqq"
                                                                                                     title="分享到QQ好友"></a><a
                    class="bds_bdhome" data-cmd="bdhome" title="分享到百度新首页"></a><a class="bds_tqf" data-cmd="tqf"
                                                                                 title="分享到腾讯朋友"></a><a
                    class="bds_renren" data-cmd="renren" title="分享到人人网"></a><a class="bds_diandian" data-cmd="diandian"
                                                                               title="分享到点点网"></a><a class="bds_youdao"
                                                                                                     data-cmd="youdao"
                                                                                                     title="分享到有道云笔记"></a><a
                    class="bds_ty" data-cmd="ty" title="分享到天涯社区"></a><a class="bds_kaixin001" data-cmd="kaixin001"
                                                                        title="分享到开心网"></a><a class="bds_taobao"
                                                                                              data-cmd="taobao"></a><a
                    class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a><a class="bds_fbook" data-cmd="fbook"
                                                                               title="分享到Facebook"></a><a
                    class="bds_twi" data-cmd="twi" title="分享到Twitter"></a><a class="bds_mail" data-cmd="mail"
                                                                             title="分享到邮件分享"></a><a class="bds_copy"
                                                                                                    data-cmd="copy"
                                                                                                    title="分享到复制网址"></a><a
                    class="bds_more" data-cmd="more">更多</a> <span>(</span><a class="bds_count" data-cmd="count"
                                                                             title="累计分享0次">0</a><span>)</span></div>
            <div class="article-tags">标签：<a
                    href="http://cmsblogs.com/?tag=%e3%80%90%e6%ad%bb%e7%a3%95sharding-jdbc%e3%80%91" rel="tag">【死磕sharding-jdbc】</a><a
                    href="http://cmsblogs.com/?tag=%e6%ad%bb%e7%a3%95java" rel="tag">死磕Java</a></div>
            <div class="article-author">
                <img data-src="https://secure.gravatar.com/avatar/7acd392fc113691267416012fcfd9b7d?s=100&amp;d=mm"
                     class="avatar avatar-100" height="50" width="50"
                     src="http://cmsblogs.com/wp-content/themes/dux/img/avatar-default.png">    <h4><i
                    class="fa fa-user" aria-hidden="true"></i>
                <a title="查看更多文章" href="http://cmsblogs.com/?author=568">飞哥-Javaer</a>
            </h4>
            </div>
            <div class="relates">
                <div class="title"><h3>相关推荐</h3></div>
                <ul>
                    <li><a href="http://cmsblogs.com/?p=2618">【死磕Sharding-jdbc】—orchestration简介&amp;使用</a></li>
                    <li><a href="http://cmsblogs.com/?p=2604">【死磕Sharding-jdbc】—SQL解析-INSERT解析</a></li>
                    <li><a href="http://cmsblogs.com/?p=2601">【死磕Sharding-jdbc】—SQL解析-词法分析</a></li>
                    <li><a href="http://cmsblogs.com/?p=2599">【死磕Sharding-jdbc】—基于 SSM 集成sharding-jdbc2.0.3</a></li>
                    <li><a href="http://cmsblogs.com/?p=2614">18、【死磕Sharding-jdbc】—复杂路由实现</a></li>
                    <li><a href="http://cmsblogs.com/?p=2467">【死磕Netty】—–Netty的核心组件</a></li>
                    <li><a href="http://cmsblogs.com/?p=2464">【死磕Netty】—–NIO基础详解</a></li>
                    <li><a href="http://cmsblogs.com/?p=2458">【死磕Java并发】—–分析 ArrayBlockingQueue 构造函数加锁问题</a></li>
                </ul>
            </div>
            <a name="comments"></a>
            <div id="SOHUCS" sid="2620">
                <div id="SOHU_MAIN">
                    <div node-type="cy-collection-btn" class="cy-collection-btn"><i></i><span>收藏文章</span></div>
                    <div class="module-cmt-header">
                        <div class="cy-hidden">
                            <button id="jump-to-kz"></button>
                        </div>
                        <div class="clear-g section-title-w">
                            <div class="title-user-w">
                                <div node-type="user" class="clear-g user-wrap-w">
                                    <span node-type="user-name" class="wrap-name-w"></span>
                                </div>
                            </div>
                        </div>
                        <div class="section-cbox-w">
                            <div class="cbox-block-w clear-g">
                                <div node-type="block-head-w" class="block-head-w">
                                    <div node-type="avatar" class="head-img-w">
                                        <a href="javascript:void(0);">
                                            <img node-type="user-head"
                                                 src="https://changyan.sohu.com/upload/asset/scs/images/pic/pic42_null.gif"
                                                 width="42" height="42" alt="">
                                            <div node-type="head-img-ie-mask" class="head-img-ie-mask"></div>
                                        </a>
                                        <div node-type="notice-node" style="display: none"
                                             class="cy-avatar-notice-node"></div>
                                    </div>
                                    <div node-type="header-login" class="header-login">登录</div>
                                    <!-- <div class="cy-to-shequ-head">
                                       -     <span>我的社区</span>
                                       - </div> -->
                                    <img node-type="header-skin" class="header-skin">
                                    <div node-type="cy-hot-words" class="cy-hot-words"></div>
                                </div>
                                <div node-type="login-select" class="block-post-w">
                                    <!-- 放置cbox初始状态 -->
                                    <div class="module-cmt-box">
                                        <!-- 展开状态 -->
                                        <div class="post-wrap-w">
                                            <div class="post-wrap-border-l"></div>
                                            <div class="post-wrap-border-r"></div>
                                            <div node-type="post-wrap-main" class="post-wrap-main">
                                                <div class="post-wrap-border-t">
                                                    <div node-type="post-wrap-border-t-l"
                                                         class="post-wrap-border-t-l"></div>
                                                    <div node-type="post-wrap-border-t-r"
                                                         class="post-wrap-border-t-r"></div>
                                                </div>
                                                <div class="wrap-area-w">
                                                    <div class="area-textarea-w">
                                                        <textarea node-type="textarea" name=""
                                                                  class="textarea-fw textarea-bf">有事没事说两句...</textarea>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="clear-g wrap-action-w">
                                                <div class="action-function-w">
                                                    <ul class="clear-g">
                                                        <li node-type="function-face" class="function-face-w">
                                                            <a class="effect-w" href="javascript:void(0)">
                                                                <i class="face-b"></i>
                                                            </a>
                                                        </li>
                                                        <li node-type="function-uploading" class="function-uploading-w">
                                                            <a class="effect-w" href="javascript:void(0)" title="上传图片">
                                                                <i class="uploading-b"></i>
                                                            </a>
                                                            <div class="uploading-file-w">
                                                                <a href="javascript:void(0);" name=""
                                                                   class="file-fw"></a>
                                                            </div>
                                                            <form style="display: none;"><input name="file" type="file"
                                                                                                accept="image/jpg,image/jpeg,image/png">
                                                            </form>
                                                        </li>
                                                    </ul>
                                                    <!-- 表情 -->
                                                    <div node-type="face-box" class="face-wrapper-dw">
                                                        <div node-type="face-cont" class="wrapper-cont-dw">
                                                            <ul class="clear-g">
                                                                <li>
                                                                    <span title="流汗" data_path="base" data-ubb="/流汗"
                                                                          class="face-item face_01"></span>
                                                                </li>
                                                                <li>
                                                                    <span title="钱" data_path="base" data-ubb="/钱"
                                                                          class="face-item face_02"></span>
                                                                </li>
                                                                <li>
                                                                    <span title="发怒" data_path="base" data-ubb="/发怒"
                                                                          class="face-item face_03"></span>
                                                                </li>
                                                                <li>
                                                                    <span title="浮云" data_path="base" data-ubb="/浮云"
                                                                          class="face-item face_04"></span>
                                                                </li>
                                                                <li>
                                                                    <span title="给力" data_path="base" data-ubb="/给力"
                                                                          class="face-item face_05"></span>
                                                                </li>
                                                                <li>
                                                                    <span title="大哭" data_path="base" data-ubb="/大哭"
                                                                          class="face-item face_06"></span>
                                                                </li>
                                                                <li>
                                                                    <span title="憨笑" data_path="base" data-ubb="/憨笑"
                                                                          class="face-item face_07"></span>
                                                                </li>
                                                                <li>
                                                                    <span title="色" data_path="base" data-ubb="/色"
                                                                          class="face-item face_08"></span>
                                                                </li>
                                                            </ul>
                                                            <ul class="clear-g">
                                                                <li>
                                                                    <span title="奋斗" data_path="base" data-ubb="/奋斗"
                                                                          class="face-item face_09"></span>
                                                                </li>
                                                                <li>
                                                                    <span title="鼓掌" data_path="base" data-ubb="/鼓掌"
                                                                          class="face-item face_10"></span>
                                                                </li>
                                                                <li>
                                                                    <span title="鄙视" data_path="base" data-ubb="/鄙视"
                                                                          class="face-item face_11"></span>
                                                                </li>
                                                                <li>
                                                                    <span title="可爱" data_path="base" data-ubb="/可爱"
                                                                          class="face-item face_12"></span>
                                                                </li>
                                                                <li>
                                                                    <span title="闭嘴" data_path="base" data-ubb="/闭嘴"
                                                                          class="face-item face_13"></span>
                                                                </li>
                                                                <li>
                                                                    <span title="疑问" data_path="base" data-ubb="/疑问"
                                                                          class="face-item face_14"></span>
                                                                </li>
                                                                <li>
                                                                    <span title="抓狂" data_path="base" data-ubb="/抓狂"
                                                                          class="face-item face_15"></span>
                                                                </li>
                                                                <li>
                                                                    <span title="惊讶" data_path="base" data-ubb="/惊讶"
                                                                          class="face-item face_16"></span>
                                                                </li>
                                                            </ul>
                                                            <ul class="clear-g">
                                                                <li>
                                                                    <span title="可怜" data_path="base" data-ubb="/可怜"
                                                                          class="face-item face_17"></span>
                                                                </li>
                                                                <li>
                                                                    <span title="弱" data_path="base" data-ubb="/弱"
                                                                          class="face-item face_18"></span>
                                                                </li>
                                                                <li>
                                                                    <span title="强" data_path="base" data-ubb="/强"
                                                                          class="face-item face_19"></span>
                                                                </li>
                                                                <li>
                                                                    <span title="握手" data_path="base" data-ubb="/握手"
                                                                          class="face-item face_20"></span>
                                                                </li>
                                                                <li>
                                                                    <span title="拳头" data_path="base" data-ubb="/拳头"
                                                                          class="face-item face_21"></span>
                                                                </li>
                                                                <li>
                                                                    <span title="酒" data_path="base" data-ubb="/酒"
                                                                          class="face-item face_22"></span>
                                                                </li>
                                                                <li>
                                                                    <span title="玫瑰" data_path="base" data-ubb="/玫瑰"
                                                                          class="face-item face_23"></span>
                                                                </li>
                                                                <li>
                                                                    <span title="打酱油" data_path="base" data-ubb="/打酱油"
                                                                          class="face-item face_24"></span>
                                                                </li>
                                                            </ul>
                                                        </div>
                                                        <div node-type="user-face-cont"
                                                             class="wrapper-user-face-dw nano">
                                                            <div class="nano-content">
                                                                <ul class="clear-g">
                                                                    <li class="upload-face-btn"></li>
                                                                    <li class="manage-face-btn"></li>
                                                                    <li class="cancel-face-btn"></li>
                                                                </ul>
                                                            </div>
                                                        </div>
                                                        <div node-type="face-tab" class="action-face-tab-dw">
                                                            <ul class="clear-g">
                                                                <li node-type="official-face"
                                                                    class="official-face-btn active"></li>
                                                                <li node-type="user-face" class="user-face-btn"></li>
                                                            </ul>
                                                        </div>
                                                        <div node-type="confirm-box" class="cy-confirm-box">
                                                            <div class="cy-confirm-text">
                                                                <span>表情删除后不可恢复，是否删除</span>
                                                            </div>
                                                            <div class="cy-confirm-btn-row">
                                                                <div class="cy-confirm-btn-cancel">取消</div>
                                                                <div class="cy-confirm-btn-confirm">确定</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <!--  上传图片 --><!--  uploading-efw -->
                                                    <div node-type="uploading-wrapper"
                                                         class="uploading-wrapper-dw uploading-efw ">
                                                        <div class="uploading-wrapper-dw-t"></div>
                                                        <div class="uploading-wrapper-dw-b"></div>
                                                        <div node-type="image-uploading" class="wrapper-loading-dw">
                                                            <div class="loading-word-dw"><span
                                                                    class="word-icon-dw"></span>图片正在上传，请稍后...
                                                            </div>
                                                            <div class="loading-btn-dw">
                                                                <a href="javascript:void(0)">取消上传</a>
                                                            </div>
                                                        </div>
                                                        <div node-type="image-uploaded" class="wrapper-image-dw">
                                                            <div class="image-close-dw">
                                                                <a href="javascript:void(0)"></a>
                                                            </div>
                                                            <div class="image-pic-dw">
                                                                <img node-type="image-pic" alt="" src="">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="clear-g action-issue-w">
                                                    <div class="issue-btn-w">
                                                        <a href="javascript:void(0)">
                                                            <button node-type="issue" class="btn-fw"></button>
                                                        </a>
                                                    </div>
                                                    <!--
                                                    <div class="issue-icon-w" node-type="share-icons">
                                                        </div>
                                                    -->
                                                </div>
                                                <div class="cbox-prompt-w" node-type="error-tips">
                                                    <span node-type="prompt-empty" class="prompt-empty-w">评论内容为空！</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 放置cbox发布状态 -->
                                    <!-- 提示条 -->
                                    <!-- 零评论提示条 -->
                                    <div class="list-comment-empty-w">
                                        <div node-type="empty-prompt" class="empty-prompt-w">
                                            <span class="prompt-null-w">还没有评论，快来抢沙发吧！</span>
                                        </div>
                                    </div>
                                    <!-- 提示连接到快站社区 -->
                                    <!-- <div class="list-comment-kuaizhan-w">
                                        <div node-type="kuaizhan-prompt" class="kuaizhan-prompt-w">
                                            <span class="prompt-text-w">点击查看更多精彩内容</span>
                                        </div>
                                    </div> -->
                                    <!--关闭评论-->
                                    <div class="list-close-comment-w">

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div><!-- 评论列表  S -->
                    <div node-type="module-cmt-list" class="module-cmt-list section-list-w">
                        <!-- 最新评论 -->
                        <div class="list-block-gw list-newest-w">
                            <div node-type="cmt-list-title" class="block-title-gw" style="display: none;">
                                <ul class="clear-g">
                                    <li>
                                        <div class="title-name-gw title-name-bg">
                                            <div class="title-name-gw-tag"></div>
                                            最新评论
                                        </div>
                                    </li>
                                </ul>
                            </div>
                            <div node-type="cmt-list" id="cy-cmt-list">
                                <div node-type="ad-pc-feed" data-id="25" class="clear-g block-cont-gw" id="feedAv"
                                     style="display:block !important; visibility:visible !important; overflow:visible !important; opacity: 1 !important; height: auto !important;">
                                    <div id="MZADX_205185" style="visibility: visible; opacity: 1;"></div>
                                    <div id="MZADX_205180" style="visibility: visible; opacity: 1;"></div>
                                    <div class="cont-head-gw" style="visibility: visible; opacity: 1;">
                                        <div class="head-img-gw" style="visibility: visible; opacity: 1;">
                                            <a node-type="flow-icon" href="https://changyan.kuaizhan.com/detail#advert"
                                               title="畅言商业版" style="visibility: visible; opacity: 1;">
                                                <div class="img-corner" style="visibility: visible; opacity: 1;"></div>
                                                <img src="http://0d077ef9e74d8.cdn.sohucs.com/qY8a0Zb_png" width="42"
                                                     height="42" alt="" style="visibility: visible; opacity: 1;">
                                            </a>
                                        </div>
                                    </div>
                                    <div class="cont-msg-gw" style="visibility: visible; opacity: 1;">
                                        <div class="msg-wrap-gw" style="visibility: visible; opacity: 1;">
                                            <div class="wrap-user-gw global-clear-spacing"
                                                 style="visibility: visible; opacity: 1;">
                                                <span node-type="feed-name" class="user-name-gw"
                                                      style="visibility: visible; opacity: 1;"><a
                                                        href="https://changyan.kuaizhan.com/detail#advert"
                                                        style="visibility: visible; opacity: 1;">畅言商业版</a></span>
                                            </div>
                                            <div class="wrap-issue-gw" style="visibility: visible; opacity: 1;">
                                                <a href="https://changyan.kuaizhan.com/detail#advert" target="_blank"
                                                   data-id="25" style="visibility: visible; opacity: 1;">
                                                    <p class="issue-wrap-gw"><span class="wrap-word-gw"
                                                                                   style="visibility: visible; opacity: 1;">畅言正式推出商业版包月/包年VIP服务，评论流弹窗位置全站去广告，一对一专业技术支持，一对一重点客户服务，现在就加入我们的VIP大家庭吧！</span>
                                                    </p>
                                                </a>
                                            </div>
                                            <!-- 图片展示开始 -->
                                            <div node-type="image-view" class="wrap-picture-show-gw"
                                                 style="background: transparent; visibility: visible; opacity: 1;">
                                                <div class="picture-box-gw picture-box-bg cy-feed-picture-box"
                                                     style="visibility: visible; opacity: 1;">
                                                    <div class="box-area-gw" id="clickPic"
                                                         style="visibility: visible; opacity: 1;">
                                                        <a href="https://changyan.kuaizhan.com/detail#advert"
                                                           target="_blank" data-id="25"
                                                           style="visibility: visible; opacity: 1;">
                                                            <img node-type="ad-feed-image" class="cy-ad-feed-image"
                                                                 src="http://0d077ef9e74d8.cdn.sohucs.com/qY8amx8_png"
                                                                 style="height: 144px; width: 576px; visibility: visible; opacity: 1;">
                                                        </a>
                                                    </div>
                                                    <div id="MZADX_205186"
                                                         style="visibility: visible; opacity: 1;"></div>
                                                </div>
                                            </div>
                                            <!-- 图片展示结束 -->
                                            <div node-type="btns-bar" class="clear-g wrap-action-gw"
                                                 style="visibility: visible; opacity: 1;">
                                                <a href="http://changyan.kuaizhan.com/" target="_blank" data-id="25"
                                                   style="visibility: visible; opacity: 1;">
                                                    <span style="width: 30px; height: 14px; line-height: 14px; text-align: center; color: rgb(67, 151, 237); font-size: 12px; border: 1px solid rgb(67, 151, 237); border-radius: 2px; cursor: pointer; visibility: visible; opacity: 1;">广告</span>
                                                </a>
                                                <div class="action-from-gw cy-feed-show-detail" id="clickMore"
                                                     style="visibility: visible; opacity: 1;">
                                                    <a href="https://changyan.kuaizhan.com/detail#advert"
                                                       target="_blank" node-type="feed-detail-link" data-id=""
                                                       style="visibility: visible; opacity: 1;">查看详情&gt;</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- 评论列表  E -->
                    <div class="module-cmt-footer">
                        <!-- 评论关闭 -->
                        <div class="list-comment-close-w">
                            <div class="close-wrap-w close-wrap-b">该评论已关闭!</div>
                        </div>
                        <!-- 翻页 -->
                        <div class="section-page-w">
                        </div>
                        <!-- 某站正在使用畅言 -->
                        <div class="section-service-w">
                            <div class="service-wrap-w">
                                <a href="http://changyan.kuaizhan.com/" target="_blank">

                                    cmsblogs正在使用畅言
                                </a>
                            </div>
                        </div>
                        <div node-type="cy-to-shequ" class="cy-redirect-btn">
                            <span class="cy-redirect-text">去社区看看吧</span><i class="cy-right-arrow"></i>
                        </div>
                        <div node-type="cy-to-hots" class="cy-redirect-btn">
                            <span class="cy-redirect-text">去热评看看吧</span><i class="cy-right-arrow"></i>
                        </div>
                        <div class="cy-to-shequ-float"></div>
                    </div>
                    <div node-type="hot-topic" class="module-hot-topic clear-g" style="">
                        <div class="images-slider" node-type="imagesCon" style="">
                            <div class="forStep">
                                <ul class="sliders" style="left: -320px;">

                                    <li class="slider" style="left: 0px;">
                                        <a href="http://cmsblogs.com/?p=2540" target="_blank">
                                            <img src="http://0d077ef9e74d8.cdn.sohucs.com/topic_picture_6"
                                                 alt="sharding-jdbc源码分析—结果合并总结-cmsblogs-chenssy">
                                        </a>
                                        <div class="opacity" node-type="opacity">
                                            <div class="foropicity"></div>
                                            <div class="text-background">
                                                <a class="text" href="http://cmsblogs.com/?p=2540"
                                                   title="sharding-jdbc源码分析—结果合并总结-cmsblogs-chenssy" target="_blank">sharding-jdbc源码分析—结果合并总结-cmsblogs-chenssy</a>
                                            </div>
                                        </div>
                                    </li>

                                    <li class="slider">
                                        <a href="http://cmsblogs.com/?p=2574" target="_blank">
                                            <img src="http://0d077ef9e74d8.cdn.sohucs.com/topic_picture_18"
                                                 alt="阅读源码的三种境界-cmsblogs-chenssy">
                                        </a>
                                        <div class="opacity" node-type="opacity">
                                            <div class="foropicity"></div>
                                            <div class="text-background">
                                                <a class="text" href="http://cmsblogs.com/?p=2574"
                                                   title="阅读源码的三种境界-cmsblogs-chenssy" target="_blank">阅读源码的三种境界-cmsblogs-chenssy</a>
                                            </div>
                                        </div>
                                    </li>

                                    <li class="slider">
                                        <a href="http://cmsblogs.com/?p=2620" target="_blank">
                                            <img src="http://0d077ef9e74d8.cdn.sohucs.com/topic_picture_21"
                                                 alt="【死磕Sharding-jdbc】—orchestration实现-cmsblogs-chenssy">
                                        </a>
                                        <div class="opacity" node-type="opacity">
                                            <div class="foropicity"></div>
                                            <div class="text-background">
                                                <a class="text" href="http://cmsblogs.com/?p=2620"
                                                   title="【死磕Sharding-jdbc】—orchestration实现-cmsblogs-chenssy"
                                                   target="_blank">【死磕Sharding-jdbc】—orchestration实现-cmsblogs-chenssy</a>
                                            </div>
                                        </div>
                                    </li>

                                    <li class="slider">
                                        <a href="http://cmsblogs.com/?p=2530" target="_blank">
                                            <img src="http://0d077ef9e74d8.cdn.sohucs.com/topic_picture_19"
                                                 alt="03、sharding-jdbc源码分析—路由&amp;执行-cmsblogs-chenssy">
                                        </a>
                                        <div class="opacity" node-type="opacity">
                                            <div class="foropicity"></div>
                                            <div class="text-background">
                                                <a class="text" href="http://cmsblogs.com/?p=2530"
                                                   title="03、sharding-jdbc源码分析—路由&amp;执行-cmsblogs-chenssy"
                                                   target="_blank">03、sharding-jdbc源码分析—路由&amp;执行-cmsblogs-chenssy</a>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                                <div class="step">
                                    <span class="next" node-type="next"></span>
                                    <span class="previous" node-type="previous"></span>
                                </div>
                            </div>
                            <ul class="images">

                                <li class="image" node-type="sliders">
                                    <img src="http://0d077ef9e74d8.cdn.sohucs.com/topic_picture_6"
                                         alt="sharding-jdbc源码分析—结果合并总结-cmsblogs-chenssy">
                                    <div class="shadow"></div>
                                </li>

                                <li class="image current" node-type="sliders">
                                    <img src="http://0d077ef9e74d8.cdn.sohucs.com/topic_picture_18"
                                         alt="阅读源码的三种境界-cmsblogs-chenssy">
                                    <div class="shadow"></div>
                                </li>

                                <li class="image" node-type="sliders">
                                    <img src="http://0d077ef9e74d8.cdn.sohucs.com/topic_picture_21"
                                         alt="【死磕Sharding-jdbc】—orchestration实现-cmsblogs-chenssy">
                                    <div class="shadow"></div>
                                </li>

                                <li class="image" node-type="sliders">
                                    <img src="http://0d077ef9e74d8.cdn.sohucs.com/topic_picture_19"
                                         alt="03、sharding-jdbc源码分析—路由&amp;执行-cmsblogs-chenssy">
                                    <div class="shadow"></div>
                                </li>
                            </ul>
                        </div>
                        <div class="topic" node-type="topic" style="width: 508px;">
                            <span class="title">热评话题</span>
                            <ul class="topic-list">

                                <li>
                                    <a href="http://cmsblogs.com/?p=2530"
                                       title="03、sharding-jdbc源码分析—路由&amp;执行-cmsblogs-chenssy" target="_blank">03、sharding-jdbc源码分析—路由&amp;执行-cmsblogs-chenssy</a>
                                </li>

                                <li>
                                    <a href="http://cmsblogs.com/?p=2552"
                                       title="sharding-jdbc源码分析—异常处理-cmsblogs-chenssy" target="_blank">sharding-jdbc源码分析—异常处理-cmsblogs-chenssy</a>
                                </li>

                                <li>
                                    <a href="http://cmsblogs.com/?p=2534"
                                       title="sharding-jdbc源码分析—结果合并-cmsblogs-chenssy" target="_blank">sharding-jdbc源码分析—结果合并-cmsblogs-chenssy</a>
                                </li>

                                <li>
                                    <a href="http://cmsblogs.com/?p=2538"
                                       title="sharding-jdbc源码分析—group by结果合并(2)-cmsblogs-chenssy" target="_blank">sharding-jdbc源码分析—group
                                        by结果合并(2)-cmsblogs-chenssy</a>
                                </li>

                                <li>
                                    <a href="http://cmsblogs.com/?p=2616"
                                       title="写了300多篇文章了，说说我为什么坚持写博客-cmsblogs-chenssy" target="_blank">写了300多篇文章了，说说我为什么坚持写博客-cmsblogs-chenssy</a>
                                </li>

                                <li>
                                    <a href="http://cmsblogs.com/?p=2536"
                                       title="sharding-jdbc源码分析—group by结果合并(1)-cmsblogs-chenssy" target="_blank">sharding-jdbc源码分析—group
                                        by结果合并(1)-cmsblogs-chenssy</a>
                                </li>

                                <li>
                                    <a href="http://cmsblogs.com/?p=2607"
                                       title="JAVA 拾遗 — CPU Cache 与缓存行-cmsblogs-chenssy" target="_blank">JAVA 拾遗 — CPU
                                        Cache 与缓存行-cmsblogs-chenssy</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="module-cmt-float-bar">
                        <div class="module-cmt-float-bar-body" style="bottom: 0;">
                            <div class="close-w"><a node-type="close" href="javascript:void(0)">关闭</a></div>
                            <div class="float-bar-logo"></div>
                            <div class="wrap-cont-w">
                                <!-- 评论 Begin -->
                                <div class="cont-minwidth-w">
                                    <div class="cont-form-w">
                                        <!-- 圆角 -->
                                        <div class="hidden-corner"></div>
                                        <!-- 圆角end -->
                                        <!-- 登录 Begin -->
                                        <div class="fb-login-wrap-w" style=" display: none ">
                            <span node-type="fb-user-name" class="user-info">
                                <img src="">
                            </span>
                                        </div>
                                        <div class="fb-logout-wrap-w" style="">
                                            <span node-type="float-bar-login" class="logout-img"></span>
                                        </div>
                                        <!-- 登录 end -->
                                        <div node-type="post-form" class="form-text-w">
                                            <a class="button-w" href="javascript:void(0)">按钮</a>
                                            <input type="text" value="" class="text-w" data-default="">
                                            <span class="text-null">内容不能为空！</span>
                                        </div>
                                    </div>
                                    <div class="cont-comment-w">
                                        <span class="comment-text-w" style="display:  block ">立刻说两句吧！</span>
                                        <a class="comment-link-w" href="javascript:void(0)"
                                           style="display:  none ">查看<span class="comment-link-num"><span
                                                class="comment-link-numtext">0</span></span>条评论</a>
                                    </div>
                                </div>
                                <!-- 评论 End -->
                                <div node-type="sogou-hot-words" class="fb-sogou-hot-words"></div>
                            </div>
                        </div>
                    </div>
                    <div class="module-cmt-notice" style="bottom: 976px;">
                        <ul class="nt-list">

                            <li node-type="notice-message" data-alias="message" data-type="message" data-static="static"
                                class="nt-item" style=" display: none ">
                                <div class="nt-logo"></div>
                                <a node-type="notice-content" class="nt-text" href="javascript:void(0);">你收到<i>0</i>条新通知</a>
                                <a class="nt-close" href="javascript:void(0);"></a>
                            </li>

                            <li node-type="notice-support" data-alias="support" data-type="support" data-static="static"
                                class="nt-item" style=" display: none ">
                                <div class="nt-logo"></div>
                                <a node-type="notice-content" class="nt-text" href="javascript:void(0);">你有<i>0</i>条评论收到赞同</a>
                                <a class="nt-close" href="javascript:void(0);"></a>
                            </li>

                            <li node-type="notice-reply" data-alias="reply" data-type="reply" data-static="static"
                                class="nt-item" style=" display: none ">
                                <div class="nt-logo"></div>
                                <a node-type="notice-content" class="nt-text" href="javascript:void(0);">你有<i>0</i>条新回复</a>
                                <a class="nt-close" href="javascript:void(0);"></a>
                            </li>

                            <li node-type="notice-hots" data-alias="hots" data-type="hots" data-static="static"
                                class="nt-item" style=" display: none ">
                                <div class="nt-logo"></div>
                                <a node-type="notice-content" class="nt-text"
                                   href="javascript:void(0);">本日畅言热评新鲜出炉啦！</a>
                                <a class="nt-close" href="javascript:void(0);"></a>
                            </li>

                            <li node-type="notice-task" data-alias="task" data-type="task" data-static="static"
                                class="nt-item" style=" display: none ">
                                <div class="nt-logo"></div>
                                <a node-type="notice-content" class="nt-text" href="javascript:void(0);">你有<i>0</i>个任务已完成</a>
                                <a class="nt-close" href="javascript:void(0);"></a>
                            </li>

                            <li node-type="notice-history" data-alias="history" data-type="history" data-static="static"
                                class="nt-item" style=" display: none ">
                                <div class="nt-logo"></div>
                                <a node-type="notice-content" class="nt-text" href="javascript:void(0);">你收获<i>0</i>个畅言足迹</a>
                                <a class="nt-close" href="javascript:void(0);"></a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <script type="text/javascript">
                (function () {
                    var appid = 'cysUCSlKs';
                    var conf = 'prod_75bc92fce22f86bd2d7b99deae2f701e';
                    var width = window.innerWidth || document.documentElement.clientWidth;
                    if (width < 960) {
                        window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="http://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>');
                    } else {
                        var loadJs = function (d, a) {
                            var c = document.getElementsByTagName("head")[0] || document.head || document.documentElement;
                            var b = document.createElement("script");
                            b.setAttribute("type", "text/javascript");
                            b.setAttribute("charset", "UTF-8");
                            b.setAttribute("src", d);
                            if (typeof a === "function") {
                                if (window.attachEvent) {
                                    b.onreadystatechange = function () {
                                        var e = b.readyState;
                                        if (e === "loaded" || e === "complete") {
                                            b.onreadystatechange = null;
                                            a()
                                        }
                                    }
                                } else {
                                    b.onload = a
                                }
                            }
                            c.appendChild(b)
                        };
                        loadJs("http://changyan.sohu.com/upload/changyan.js", function () {
                            window.changyan.api.config({appid: appid, conf: conf})
                        });
                    }
                })();
            </script>
            <div id="ds-ssr" style="display:none">
                <ol id="commentlist">
                </ol>

            </div>
        </div>
    </div>
{% endblock %}
{% block style %}
    <style>
         .content {
            padding: 0 20px;
            background-color: #fff;
            border: 1px solid #eaeaea;
            border-radius: 4px;
        }

    </style>
{% endblock %}
